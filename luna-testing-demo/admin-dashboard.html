<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luna Testing Program - Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            color: #1a202c;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }
        
        .sidebar {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .logo h2 {
            font-size: 1.2em;
            font-weight: 300;
        }
        
        .nav-menu {
            list-style: none;
        }
        
        .nav-menu li {
            margin-bottom: 10px;
        }
        
        .nav-menu a {
            color: white;
            text-decoration: none;
            padding: 12px 15px;
            border-radius: 8px;
            display: block;
            transition: background 0.3s;
        }
        
        .nav-menu a:hover,
        .nav-menu a.active {
            background: rgba(255,255,255,0.2);
        }
        
        .main-content {
            padding: 30px;
            overflow-y: auto;
        }
        
        .header {
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #64748b;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stat-card .number {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-card .label {
            color: #64748b;
            font-weight: 500;
        }
        
        .stat-card.phase-1 .number { color: #3b82f6; }
        .stat-card.phase-2 .number { color: #10b981; }
        .stat-card.phase-3 .number { color: #f59e0b; }
        .stat-card.total .number { color: #667eea; }
        
        .content-section {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .section-header {
            background: #f8fafc;
            padding: 20px 25px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .section-header h2 {
            font-size: 1.3em;
        }
        
        .section-header .actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .btn-secondary:hover {
            background: #cbd5e0;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .participants-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .participants-table th,
        .participants-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .participants-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #4a5568;
        }
        
        .participants-table tr:hover {
            background: #f8fafc;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .status-registered {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-scheduled {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-completed {
            background: #f3e8ff;
            color: #7c3aed;
        }
        
        .phase-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .phase-1 {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .phase-2 {
            background: #d1fae5;
            color: #065f46;
        }
        
        .phase-3 {
            background: #fef3c7;
            color: #92400e;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            margin: 0;
        }
        
        .close {
            font-size: 1.5em;
            cursor: pointer;
            color: #64748b;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .participants-table {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="sidebar">
            <div class="logo">
                <div class="icon">🌙</div>
                <h2>Luna Testing</h2>
                <p style="font-size: 0.9em; opacity: 0.8;">Admin Dashboard</p>
            </div>
            
            <ul class="nav-menu">
                <li><a href="#overview" class="nav-link active" data-section="overview">📊 Overview</a></li>
                <li><a href="#participants" class="nav-link" data-section="participants">👥 Participants</a></li>
                <li><a href="#sessions" class="nav-link" data-section="sessions">🧪 Sessions</a></li>
                <li><a href="#analytics" class="nav-link" data-section="analytics">📈 Analytics</a></li>
                <li><a href="#communications" class="nav-link" data-section="communications">📧 Communications</a></li>
            </ul>
        </div>
        
        <div class="main-content">
            <!-- Overview Section -->
            <div id="overview-section" class="content-section">
                <div class="header">
                    <h1>Testing Program Overview</h1>
                    <p class="subtitle">Monitor participant registration and testing progress</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card total">
                        <div class="number" id="total-participants">0</div>
                        <div class="label">Total Participants</div>
                    </div>
                    <div class="stat-card phase-1">
                        <div class="number" id="phase-1-count">0</div>
                        <div class="label">Technical Users</div>
                    </div>
                    <div class="stat-card phase-2">
                        <div class="number" id="phase-2-count">0</div>
                        <div class="label">Business Users</div>
                    </div>
                    <div class="stat-card phase-3">
                        <div class="number" id="phase-3-count">0</div>
                        <div class="label">Consumer Users</div>
                    </div>
                </div>
            </div>
            
            <!-- Participants Section -->
            <div id="participants-section" class="content-section">
                <div class="section-header">
                    <h2>Participants</h2>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="refreshParticipants()">🔄 Refresh</button>
                        <a href="/recruitment-landing.html" class="btn btn-secondary" target="_blank">📋 Recruitment Page</a>
                    </div>
                </div>
                
                <div id="participants-content">
                    <div class="loading">Loading participants...</div>
                </div>
            </div>
            
            <!-- Sessions Section -->
            <div id="sessions-section" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2>Testing Sessions</h2>
                    <div class="actions">
                        <button class="btn btn-success" onclick="startTestSession()">🚀 Start Session</button>
                    </div>
                </div>
                
                <div id="sessions-content">
                    <div class="loading">Loading sessions...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Schedule Testing Session</h3>
                <span class="close" onclick="closeModal('scheduleModal')">&times;</span>
            </div>
            <form id="scheduleForm">
                <input type="hidden" id="schedule-participant-id">
                <div class="form-group">
                    <label>Participant</label>
                    <input type="text" id="schedule-participant-name" readonly>
                </div>
                <div class="form-group">
                    <label>Session Date & Time</label>
                    <input type="datetime-local" id="schedule-datetime" required>
                </div>
                <div class="form-group">
                    <label>Session Type</label>
                    <select id="schedule-session-type" required>
                        <option value="installation-test">Installation Test</option>
                        <option value="usability-test">Usability Test</option>
                        <option value="feature-test">Feature Test</option>
                        <option value="interview">Interview Only</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="schedule-notes" placeholder="Additional notes or special instructions..."></textarea>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('scheduleModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Schedule Session</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Current section
        let currentSection = 'overview';
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            setupNavigation();
            
            // Auto-refresh every 30 seconds
            setInterval(loadDashboardData, 30000);
        });
        
        function setupNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;
                    switchSection(section);
                });
            });
        }
        
        function switchSection(section) {
            // Update active nav
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active');
            
            // Show/hide sections
            document.querySelectorAll('[id$="-section"]').forEach(section => {
                section.style.display = 'none';
            });
            
            if (section === 'overview') {
                document.getElementById('overview-section').style.display = 'block';
                document.getElementById('participants-section').style.display = 'block';
            } else if (section === 'participants') {
                document.getElementById('participants-section').style.display = 'block';
            } else if (section === 'sessions') {
                document.getElementById('sessions-section').style.display = 'block';
                loadSessions();
            }
            
            currentSection = section;
        }
        
        async function loadDashboardData() {
            try {
                // Load participant statistics
                const analyticsResponse = await fetch('/api/participants/analytics/summary');
                const analytics = await analyticsResponse.json();
                
                // Update stat cards
                document.getElementById('total-participants').textContent = analytics.total || 0;
                document.getElementById('phase-1-count').textContent = analytics.by_phase['phase-1'] || 0;
                document.getElementById('phase-2-count').textContent = analytics.by_phase['phase-2'] || 0;
                document.getElementById('phase-3-count').textContent = analytics.by_phase['phase-3'] || 0;
                
                // Load participants
                await loadParticipants();
                
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
            }
        }
        
        async function loadParticipants() {
            try {
                const response = await fetch('/api/participants');
                const participants = await response.json();
                
                const content = document.getElementById('participants-content');
                
                if (participants.length === 0) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #64748b;">
                            <h3>No participants yet</h3>
                            <p>Share the recruitment page to start gathering participants.</p>
                            <a href="/recruitment-landing.html" class="btn btn-primary" target="_blank">View Recruitment Page</a>
                        </div>
                    `;
                    return;
                }
                
                const tableHTML = `
                    <table class="participants-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Experience</th>
                                <th>Phase</th>
                                <th>Status</th>
                                <th>Registered</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${participants.map(participant => `
                                <tr>
                                    <td><strong>${participant.name}</strong></td>
                                    <td>${participant.email}</td>
                                    <td>${participant.role}</td>
                                    <td>${participant.experience}</td>
                                    <td><span class="phase-badge ${participant.testing_phase}">${getPhaseLabel(participant.testing_phase)}</span></td>
                                    <td><span class="status-badge status-${participant.status}">${participant.status}</span></td>
                                    <td>${new Date(participant.registered_at).toLocaleDateString()}</td>
                                    <td>
                                        ${participant.status === 'registered' ? 
                                            `<button class="btn btn-primary" onclick="scheduleParticipant('${participant.id}', '${participant.name}')">📅 Schedule</button>` :
                                            `<button class="btn btn-secondary" onclick="viewParticipant('${participant.id}')">👁️ View</button>`
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                content.innerHTML = tableHTML;
                
            } catch (error) {
                console.error('Failed to load participants:', error);
                document.getElementById('participants-content').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: #ef4444;">Failed to load participants</div>';
            }
        }
        
        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                const sessions = await response.json();
                
                const content = document.getElementById('sessions-content');
                
                if (sessions.length === 0) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #64748b;">
                            <h3>No sessions yet</h3>
                            <p>Schedule participants to start testing sessions.</p>
                        </div>
                    `;
                    return;
                }
                
                const tableHTML = `
                    <table class="participants-table">
                        <thead>
                            <tr>
                                <th>Session ID</th>
                                <th>Participant</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Started</th>
                                <th>Duration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sessions.map(session => `
                                <tr>
                                    <td><code>${session.id.substring(0, 8)}</code></td>
                                    <td>${session.participant_id || 'Demo User'}</td>
                                    <td>${session.session_type}</td>
                                    <td><span class="status-badge status-${session.status}">${session.status}</span></td>
                                    <td>${new Date(session.start_time).toLocaleString()}</td>
                                    <td>${session.end_time ? 
                                        Math.round((new Date(session.end_time) - new Date(session.start_time)) / 1000) + 's' : 
                                        'Ongoing'
                                    }</td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="viewSession('${session.id}')">👁️ View</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                content.innerHTML = tableHTML;
                
            } catch (error) {
                console.error('Failed to load sessions:', error);
            }
        }
        
        function getPhaseLabel(phase) {
            const labels = {
                'phase-1': 'Technical',
                'phase-2': 'Business', 
                'phase-3': 'Consumer'
            };
            return labels[phase] || phase;
        }
        
        function refreshParticipants() {
            loadParticipants();
        }
        
        function scheduleParticipant(participantId, participantName) {
            document.getElementById('schedule-participant-id').value = participantId;
            document.getElementById('schedule-participant-name').value = participantName;
            
            // Set default date to tomorrow at 2 PM
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(14, 0, 0, 0);
            document.getElementById('schedule-datetime').value = tomorrow.toISOString().slice(0, 16);
            
            document.getElementById('scheduleModal').style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        document.getElementById('scheduleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const participantId = document.getElementById('schedule-participant-id').value;
            const scheduledDate = document.getElementById('schedule-datetime').value;
            const sessionType = document.getElementById('schedule-session-type').value;
            const notes = document.getElementById('schedule-notes').value;
            
            try {
                const response = await fetch(`/api/participants/${participantId}/schedule`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        scheduledDate,
                        sessionType,
                        notes
                    })
                });
                
                if (response.ok) {
                    closeModal('scheduleModal');
                    loadParticipants();
                    alert('Participant scheduled successfully!');
                } else {
                    alert('Failed to schedule participant');
                }
            } catch (error) {
                console.error('Scheduling error:', error);
                alert('Failed to schedule participant');
            }
        });
        
        async function startTestSession() {
            try {
                const response = await fetch('/api/test-session/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ participantId: 'admin-demo-' + Date.now() })
                });
                
                const session = await response.json();
                alert(`Demo session started: ${session.sessionId}`);
                loadSessions();
            } catch (error) {
                console.error('Failed to start session:', error);
                alert('Failed to start session');
            }
        }
        
        function viewParticipant(participantId) {
            window.open(`/api/participants/${participantId}`, '_blank');
        }
        
        function viewSession(sessionId) {
            window.open(`/api/sessions?sessionId=${sessionId}`, '_blank');
        }
    </script>
</body>
</html>